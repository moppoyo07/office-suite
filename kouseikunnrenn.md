# 更生訓練費管理システム 改修要件定義書

## 1. プロジェクトの目的
現在、Excel/スプレッドシートの手作業と口頭伝達で行っている「更生訓練費」の請求・入金・振込管理を、自社システム「Office Suite :: Cockpit」に統合し、以下の課題を解決する。

*   **課題①：** 市への請求（区ごとの合算）と、個人への支払（個別バラバラ）の管理が複雑で整合性が取れない。
*   **課題②：** 経理担当者が訓練生の詳細や計算ロジックを知らなくても、入金登録と振込実務ができるようにしたい。
*   **課題③：** 入金消込（Reconciliation）をシステム化し、未回収や振込漏れを防ぐ。

---

## 2. 業務フロー（新設計）

1.  **【管理者】請求データの作成（自動計算＆束ねる）**
    *   利用者の出席実績から金額を計算し、「区（請求先）」ごとにデータを束ねる（グルーピング）。
2.  **【管理者】市へ請求**
    *   システムから申請書PDFを出力して市に送付。
3.  **【経理】入金情報の登録**
    *   通帳を見て、入金された「日付・名義・金額」のみをシステムに入力。
4.  **【管理者】入金消込（答え合わせ）**
    *   「区ごとの請求束」と「経理が入力した入金」を突き合わせて確定させる。
5.  **【経理】振込実行**
    *   消込が完了し、支払いが許可された個人のリストを見て振込を行う。

---

## 3. データベース設計指針（追加エンティティ）

既存の利用者DB、出欠DBに加え、以下を追加・連携させる。

### A. 請求グループテーブル (BillingBundles)
「〇〇区の11月分」という**請求の塊**を管理する。
*   `ID`
*   `請求先ID`（東区、安佐南区など）
*   `対象年月`（2025-11）
*   `請求合計額`（¥19,200 など）
*   `ステータス`（未請求 / 請求中 / **入金確認済** / 完了）

### B. 請求明細テーブル (BillingItems)
個人の請求データ。Aのグループに紐付く。
*   `ID`
*   `GroupID`（AのID）
*   `利用者ID`
*   `訓練費` / `交通費`
*   `個人合計額`（¥6,400）
*   `個人ステータス`（未払 / **振込待ち** / 振込完了）

### C. 入金記録テーブル (PaymentRecords)
経理が入力する生の入金データ。
*   `ID`
*   `入金日`
*   `振込名義`（カナ）
*   `入金額`
*   `消込フラグ`（未 / 済）

---

## 4. 画面・UI要件（ロール別）

### 【管理者（Admin）用画面】

#### ① 請求一括作成画面（Monthly Billing Creator）
*   **機能：**
    *   対象月を選択（例：2025年11月）。
    *   ボタン一発で、出席データに基づき全員分の金額を計算。
    *   **重要：** 自動的に「請求先（区）」ごとにグループ化して表示する。
    *   確定ボタンで `BillingBundles` と `BillingItems` を生成保存。
    *   各区の申請書PDF出力ボタンを設置。

#### ② 入金消込画面（Reconciliation Manager）
*   **UIイメージ：** 左右分割画面
    *   **[左] 請求グループリスト：** 「東区 11月分 ¥19,200（未入金）」などがカードで並ぶ。
    *   **[右] 入金記録リスト：** 経理が入力した「11/28 シ ヒガシ... ¥12,390」などが並ぶ。
*   **操作：**
    *   左と右の対応するデータを選択し、「紐付け（確定）」を実行。
    *   金額不一致の場合はアラートを出す。
    *   確定すると、そのグループ内の全利用者のステータスが「振込待ち」に変わる。

---

### 【経理（Accountant）用画面】

**※経理には以下のシンプル機能のみを開放する**

#### ③ 入金登録画面（Payment Input）
*   **機能：** 通帳の内容をそのまま登録するフォーム。
*   **入力項目：** `入金日` `名義（カナ）` `金額` `備考`
*   ※「これは誰の分か？」などの判断は一切させない。

#### ④ 振込依頼リスト（Payout List）
*   **機能：** 管理者が「消込（②）」を完了したデータのみが表示される。
*   **表示内容：**
    *   振込先（利用者名）
    *   銀行口座情報
    *   **振込金額**（個人の確定額）
*   **操作：**
    *   振込後、「完了」チェックを入れることで履歴に残す。

---

## 5. 開発ロードマップ（優先順位）

1.  **請求計算ロジックの実装**（まずは正解の数字を作る）
    *   マスタ（単価・ルート）整備
    *   請求作成画面の実装
2.  **経理用入力画面の実装**
    *   単純なCRUD機能でOK
3.  **消込ロジックの実装**（最重要）
    *   請求グループ vs 入金記録 のマッチング処理
4.  **振込リスト出力の実装**