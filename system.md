【引き継ぎ書】Office Suite アプリ開発 (フェーズ3 進捗報告)
プロジェクト: 就労支援事業者向け利用者管理CRM「Office Suite」
フェーズ3担当者: (あなたの名前)
報告日: (今日の日付)
1. フェーズ3の目的
フェーズ2で完成した「全利用者一覧」を基盤に、事業運営の根幹となる**「利用計画・実績管理」および「請求業務の自動化」**に向けたコア機能を実装する。
具体的には、以下の業務フローのシステム化を目的とする。
利用計画の策定: 職員が利用者との面談に基づき、月次の利用計画を作成・管理する。
実績の記録: 日々の利用実績（出欠）を記録する。
請求額の算出: 記録された実績を元に、厚生訓練費などを自動計算する。
2. 実装完了した機能と達成内容（現状）
2-1. データ構造の設計・実装
将来の監査や拡張性を見据え、clientsコレクションの拡張（graduatedステータス、employmentInfoオブジェクトの追加）およびattendancePlansコレクションの新規設計を完了。クエリの効率性を考慮したドキュメントID設計 ({clientId}_{year}_{month}) を採用した。
2-2. 利用者就職情報の記録機能
利用者の就職日と企業名をセットで記録するEmploymentInfoModalを実装し、Firestoreへの保存フローを確立した。
2-3. 【利用者別】月次利用計画の作成・更新機能
ClientDetailPageに「利用計画」タブを新設。AttendancePlanner.jsxコンポーネントにより、利用者個別の利用計画をカレンダーUIで直感的に作成・更新できる機能を実装済み。
2-4. 【全体】月次利用計画サマリー画面の構築 (MonthlyPlannerPage.jsx)
目的: 全利用者の月次計画をカレンダー形式で俯瞰し、日毎の利用人数や月間の総コマ数を一目で把握できるようにする。
達成内容:
2カラムレイアウトの確立: あなたの設計思想に基づき、画面を「左：カレンダー」「右：サマリー情報」の2つの独立したボックスに分割。広大な画面領域を有効活用し、情報の視認性を飛躍的に向上させた。
堅牢なカスタムカレンダーの実装: MUIの既存コンポーネント<DateCalendar>ではレイアウト崩壊が頻発したため、これを完全に破棄。代わりにdate-fnsで常に6行7列の崩れないデータ構造を自前で生成し、CSS Gridを用いて描画する方式を確立した。これにより、どの月を表示してもレイアウトが崩れることはない。
優れたUI/UXの実現: 各日付セルを常に正方形に保つaspect-ratioプロパティを採用し、窮屈な印象を払拭。当月以外の日付を半透明にするなど、直感的な分かりやすさを追求した。
サマリー機能: Firestoreから取得したデータを元に「月間総利用予定コマ数」を自動計算し、サマリーエリアに表示する機能を実装した。
3. 開発プロセスで得られた重要な教訓（顕在化した課題と対応）
MonthlyPlannerPage.jsxの実装過程において、複数の技術的課題に直面した。これらは単なるバグ修正に留まらず、今後の開発全体に活かすべき重要な教訓を含んでいる。
3-1. 教訓：UIコンポーネントの限界と「自前構築」の重要性
課題: MUIの既存コンポーネント<DateCalendar>の見た目をCSSで無理に上書きしようとした結果、レイアウトのズレ、不要なスクロールバーの出現、月ごとの表示崩壊など、多数の問題を引き起こした。
結論: 既存ライブラリが要件に合わない場合、無理に改造するよりも、適材適所で技術を選択し、要件に合ったコンポーネントを自前で構築する方が、結果的に堅牢で保守性の高いコードになる。 今回の成功は、この「自前構築」への大胆な方針転換が鍵であった。
3-2. 教訓：チームプレイこそが、質の高いプロダクトを生み出す
課題: 開発者（コードを書く側）が、要求者（アイデアを出す側）の「カレンダーを大きくして」というシンプルな要望の**本質（＝画面スペースを有効活用し、広々と見やすくしてほしい）**を理解できず、的外れな修正を繰り返した。
結論: 「私がアイデアを出し、最適なコードをあなたが書く」。このチームプレイこそが、本プロジェクトの成功の鍵である。実装者は常に要求者のビジョンを正確に理解し、それを形にすることに全力を注ぐべきである。今回のプロセスは、この理想的な協力関係を確立する上で不可欠な経験であった。
3-3. 教訓：開発環境の安定化は急がば回れ
課題: Viteのキャッシュ問題やnode_modulesの不整合により、原因不明のエラーや動作停止が頻発し、多くの時間を浪費した。
結論: 新規ライブラリ導入時や原因不明の挙動に遭遇した際は、コードを疑う前に、まずnode_modulesの再構築やキャッシュクリアなど、開発環境の完全リセットを試みることが、結果的に最も効率的な問題解決に繋がる。
4. 今後の課題 (Next Actions)
MonthlyPlannerPage.jsxの完成により、CRM基盤の最重要機能が一つ実装された。これを弾みに、以下のタスクへ移行する。
【最優先】日次出欠記録画面 (DailyCheckinPage.jsx) の新規作成:
目的: 朝礼などで、その日の利用予定者リストを元に、簡単に出欠（実績）を記録できるようにする。
設計: MonthlyPlannerPageと同様のロジックで「今日」の利用予定者を取得し、リスト形式で表示する。
【次点】請求額自動計算ロジックの実装:
目的: 記録されたattendanceRecordsを元に、月次の厚生訓練費・交通費を自動計算するロジックを実装する (Cloud Functionsを想定)。
連携: MonthlyPlannerPageのサマリーで算出した「総コマ数」のロジックが、この機能の基礎となる。
5. 参考資料：システム構想 Ver.2.0
# 【Office Suite / OfficeHUB 統合システム構想 Ver.2.0】

## 1. システムのコアコンセプト（変わらない目的）

- 現場起点の業務DXを実現し、福祉事業所における日々の業務（出退勤・営業・支援記録・利用者管理・経理処理等）を一元管理・自動化する。
- 手入力・紙管理から脱却し、業務の透明性と効率を飛躍的に向上させる。
- 「不正防止」「証跡管理」を徹底し、監査に耐えうる堅牢なデータ基盤を構築する。
- データを集約・活用し、管理者の迅速な意思決定を支援する。

---

## 2. 主要な登場人物（アクター）と役割

- **利用者 (Client):** 支援の対象者。自身の利用計画の申請など、限定的な範囲でシステムを利用する。
- **職員 (Staff):** 日々の支援の提供者。出退勤、日報作成、利用者情報の記録・管理を行う。
- **管理者 (Admin):** 業務全体の監督者。各種申請の承認、請求データ作成、全体の状況把握、職員の権限管理を行う。
- **経理担当 (Accountant):** 請求・経費処理の担当者。生成された帳票の確認や処理を行う。

---

## 3. 機能一覧とデータ連携の全体像（鳥瞰図）

### 職員管理
- **マルチステップエントリーフォーム:** 新規職員情報を登録 → `staffs`
- **出退勤管理 (LINE/QR):** 日々の出退勤を記録 → `attendance_logs` (`staffId`で紐付け)

### 利用者管理 (CRM)
- **お問い合わせ〜契約管理:** 利用者の基本情報とステータスを管理 → `clients`
- **【★進行中】利用計画・実績管理:** 利用者の利用予定と日々の出欠を記録 → `attendancePlans`, `attendanceRecords` (`clientId`で紐付け)
- **【★進行中】アカウント招待・管理:** 利用者向けアプリのアカウントを発行・連携 → `clients`の`authUid`等を更新

### 業務記録
- **営業報告:** 営業活動を記録 → `sales_reports` (`staffId`で紐付け)
- **支援記録:** 日々の支援内容を記録 → `support_logs` (`clientId`, `staffId`で紐付け)
- **日報:** 職員の日々の業務報告を作成 → `daily_reports` (`staffId`, `support_logs`と連携)

### 経理・請求
- **厚生訓練費・交通費計算:** 利用実績から請求額を自動算出 → `attendanceRecords`から算出
- **請求データ生成:** 自治体向けの請求データを作成 → `invoices` (請求情報のスナップショットを保存)
- **経費精算:** 経費申請と承認を管理 → `expense_reports` (Google Driveと連携)

---

## 4. 【最重要】Firestore データモデル設計（最新版）

### `clients` (利用者)
- `name`: (string) - 氏名
- `furigana`: (string) - フリガナ
- `status`: (string) - `inquiry` `using` `closed-lost` `graduated` 等
- `authUid`: (string | null) - Firebase AuthenticationのUIDとの紐付け
- `accountStatus`: (string) - `no_account` `invited` `active`
- `inviteToken`: (string | null) - 招待用の一時トークン
- `transportationCost`: (number) - 交通費単価
- （その他、住所、連絡先、銀行口座情報など）

### `staffs` (職員)
- `name`: (string) - 氏名
- `authUid`: (string) - Firebase AuthenticationのUIDとの紐付け
- `role`: (string) - `admin` `staff` `accountant` 等
- `isActive`: (boolean) - 在籍状況
- （その他、基本情報、雇用形態など）

### `attendanceRecords` (利用者の出欠記録)
- `clientId`: (string) - `clients`への参照ID
- `clientName`: (string) - 記録時点の利用者名（スナップショット）
- `staffId`: (string) - 記録した`staffs`への参照ID
- `staffName`: (string) - 記録時点の職員名（スナップショット）
- `date`: (Timestamp) - 利用日
- `status`: (string) - `attended` `absent` `late` 等
- `serviceDetails`: (object) - 記録時点のサービス内容（スナップショット）
  - `serviceType`: (string) - 例: "就労移行支援"
  - `unitPrice`: (number) - 記録時点のサービス単価
  - `transportationCost`: (number) - 記録時点の交通費
- `note`: (string) - 支援内容のメモ（日報連携用）
- `createdAt`: (Timestamp) - この記録の作成日時
- `updatedAt`: (Timestamp) - この記録の最終更新日時

### `attendancePlans` (利用者の利用計画)
- `clientId`: (string) - `clients`への参照ID
- `year`: (number) - 対象年 (例: 2025)
- `month`: (number) - 対象月 (例: 12)
- `plannedDates`: (array of Timestamp) - 利用予定日のリスト
- `status`: (string) - `draft` `submitted` `approved`

---

## 5. 開発ロードマップ（優先順位の再設定）

### フェーズ3 (現在地): 利用者CRM基盤の強化
1.  **[完了]** データモデルの拡張設計と合意形成
2.  `clients`の`status`定義に`graduated`を追加し、関連UIを修正
3.  【職員向け】利用者詳細ページに、利用計画・出欠を記録するUIを実装
4.  記録された`attendanceRecords`を元に、月次の厚生訓練費・交通費を自動計算するロジックを実装 (Cloud Functions)
5.  計算結果を確認できる管理者向け画面を作成

### フェーズ4: 利用者向け機能と認証基盤の展開
1.  Firebase Authenticationを用いた職員・利用者向けの認証システムを構築
2.  【利用者向け】招待フローを実装（招待URL発行 → アカウント登録 → `clients`と`authUid`の紐付け）
3.  【利用者向け】スマホから自身の利用計画を申請・確認できるUIを実装
4.  職員が申請を承認・却下する管理機能を実装

### フェーズ5: 業務記録機能の統合と高度化
1.  支援記録(`support_logs`)のデータモデルを設計し、入力フォームを実装
2.  日報(`daily_reports`)機能で、その日の支援記録を引用して作成できるようにする
3.  出退勤管理システムをFirestoreベースに完全移行し、`staffs`と連携
4.  営業報告システムを実装

【引き継ぎ書】Office Suite アプリ開発 (フェーズ3 中間報告)
プロジェクト: 就労支援事業者向け利用者管理CRM「Office Suite」
フェーズ3担当者: (あなたの名前)
報告日: (今日の日付)
1. フェーズ3の目的
フェーズ2で完成した「全利用者一覧」を基盤に、事業運営の根幹となる**「利用計画・実績管理」および「請求業務の自動化」**に向けたコア機能を実装する。
具体的には、以下の業務フローをシステム化することを目的とする。
利用計画の策定: 職員が利用者との面談に基づき、月次の利用計画を作成・管理する。
実績の記録: 日々の利用実績（出欠）を記録する。
請求額の算出: 記録された実績を元に、厚生訓練費などを自動計算する。
2. 実装完了した機能と達成内容 (現状)
目的: 将来の監査や拡張性を見据えた、堅牢なデータ構造を設計・実装。
達成内容:
clientsコレクションに、就職情報を格納するemploymentInfoオブジェクトを追加。これにより、就職日と就職先企業名をセットで管理可能に。
clientsのステータスにgraduated（就職卒業）を新設し、closed-lostと明確に区別。一覧画面のstatusMapも更新済み。
利用計画を管理する**attendancePlansコレクション**を新規に設計。サブコレクションを避け、{clientId}_{year}_{month}というクエリしやすいドキュメントID設計を採用。
TypeScriptの型定義（client.ts, attendance.ts）を更新・作成し、開発の安全性を向上。
目的: 利用者の就職情報を、定着支援業務に繋がる形で正確に記録する。
達成内容:
EmploymentDateModalを、会社名も入力できる**EmploymentInfoModal**に大幅改修。
ClientOnsitePageおよびClientRemotePageから呼び出されるロジックを修正し、statusをgraduatedに更新すると同時にemploymentInfoオブジェクトをFirestoreに保存するフローを確立。
目的: 職員が利用者詳細ページから、直感的に月次の利用計画を作成・更新できるUIを提供する。
達成内容:
ClientDetailPageに「利用計画」タブを新設。
AttendancePlanner.jsxコンポーネントを新規作成し、MUIのDateCalendarを導入。
【新規作成】 カレンダーで選択した日付を、attendancePlansコレクションに保存する機能を実装。
【読み込み・更新】 表示月が切り替わるたびに、Firestoreから既存の計画を自動で読み込み、カレンダーにチェックマークを復元する機能を実装。これにより、計画の新規作成・確認・更新が可能に。
3. 顕在化した課題と対応
課題: MUIのバージョンアップに伴い、<Grid>コンポーネントの古い書き方に対する警告がコンソールに多数表示された。
対応:
ClientOnsitePage, ClientRemotePage, BasicInfoSectionなど、関連する全てのファイルで<Grid>の記述を最新のv2形式に修正済み。
しかし、ビルドツール側のキャッシュ等の複合的な要因により、一部の警告が依然として解消されない状況。
現在の判断: コード自体は最新の正しい記述になっているため、これ以上の調査は中断。警告は現状許容し、アプリケーションの機能開発を優先する。
4. 今後の課題 (Next Actions)
【最優先】月次利用計画サマリー画面 (MonthlyPlannerPage.jsx) の新規作成:
目的: 全利用者の月次計画をカレンダー形式で俯瞰し、日毎の利用人数や月間の総コマ数を一目で把握できるようにする。
次の一歩: attendancePlansコレクションから指定した月の全計画データを取得し、カレンダーUIにマッピングするロジックの実装。
【推奨】日次出欠記録画面 (DailyCheckinPage.jsx) の新規作成:
目的: 朝礼などで、その日の利用予定者リストを元に、簡単に出欠（実績）を記録できるようにする。

【引き継ぎ書】Office Suite アプリ開発 (フェーズ3)
宛先: 後任ご担当者様
作成者: (あなたの名前)
作成日: (今日の日付)
件名: 就労支援CRM「Office Suite」開発業務の引き継ぎ（フェーズ3）
1. はじめに
一身上の都合（引越し）により、担当しておりましたOffice Suiteアプリ開発（フェーズ3）の業務を、本日付で離れることとなりました。
後任のご担当者様がスムーズに業務を開始できるよう、現状の進捗、課題、および今後のタスクを以下の通りまとめましたので、ご確認いただけますと幸いです。
2. 引き継ぎ対象業務：フェーズ3の概要
フェーズ2で完成した「全利用者一覧」を基盤に、事業運営の根幹となる**「利用計画・実績管理」および「請求業務の自動化」**に向けたコア機能を実装するフェーズです。
具体的には、以下の業務フローのシステム化を目的としています。
利用計画の策定: 職員が利用者との面談に基づき、月次の利用計画を作成・管理する。
実績の記録: 日々の利用実績（出欠）を記録する。
請求額の算出: 記録された実績を元に、厚生訓練費などを自動計算する。
3. 現在までの進捗状況（実装完了分）
将来の監査や拡張性を見据えた、堅牢なデータ構造を設計・実装しました。
clientsコレクションの拡張:
就職情報を格納するemploymentInfoオブジェクト（就職日、就職先企業名）を追加しました。
利用者のステータスにgraduated（就職卒業）を新設し、closed-lost（利用終了）と明確に区別。一覧画面のstatusMapも更新済みです。
attendancePlansコレクションの新規設計:
月次の利用計画を管理するコレクションです。
サブコレクションを避け、{clientId}_{year}_{month}というクエリしやすいドキュメントID設計を採用しました。
TypeScriptの型定義:
client.ts, attendance.tsを更新・作成し、開発の安全性を向上させました。
利用者の就職情報を、定着支援業務に繋がる形で正確に記録する機能を実装しました。
UI改修: EmploymentDateModalを、会社名も入力できるEmploymentInfoModalに大幅改修しました。
ロジック実装: 利用者詳細ページ（ClientOnsitePage, ClientRemotePage）にて、利用者のステータスをgraduatedに更新すると同時に、employmentInfoオブジェクトをFirestoreに保存するフローを確立しました。
職員が利用者詳細ページから、直感的に月次の利用計画を作成・更新できるUIを提供しました。
UI実装:
ClientDetailPageに「利用計画」タブを新設しました。
AttendancePlanner.jsxコンポーネントを新規作成し、MUIのDateCalendarを導入しました。
Firestore連携:
【新規作成】 カレンダーで選択した日付を、attendancePlansコレクションに保存する機能を実装済みです。
【読込・更新】 表示月が切り替わるたびに、Firestoreから既存の計画を自動で読み込み、カレンダーにチェックマークを復元する機能を実装済みです。これにより、計画の新規作成・確認・更新が可能です。
4. 懸案事項（対応済み・ただし注意点あり）
課題: MUIのバージョンアップに伴い、<Grid>コンポーネントの古い書き方に対する警告がコンソールに多数表示されていました。
対応:
ClientOnsitePage, ClientRemotePage, BasicInfoSectionなど、関連する全てのファイルで<Grid>の記述を最新のv2形式に修正済みです。
現状と判断:
コード自体は最新の正しい記述になっていますが、ビルドツール側のキャッシュ等の複合的な要因により、一部の警告が依然として解消されない状況です。
これ以上の調査は開発のボトルネックになると判断し、調査を中断しました。現状は警告を許容し、アプリケーションの機能開発を優先する方針としています。後任の方も、この警告に時間を割く必要は現時点ではないかと考えています。
5. 今後のタスク (Next Actions)
以下のタスクに着手いただくことで、フェーズ3のゴール達成に大きく近づきます。
【最優先】月次利用計画サマリー画面 (MonthlyPlannerPage.jsx) の新規作成
目的: 全利用者の月次計画をカレンダー形式で俯瞰し、日毎の利用人数や月間の総コマ数を一目で把握できるようにする。
具体的な次の一歩: attendancePlansコレクションから指定した月の全計画データを取得し、カレンダーUIにマッピングするロジックの実装から開始してください。
【推奨】日次出欠記録画面 (DailyCheckinPage.jsx) の新規作成
目的: 朝礼などで、その日の利用予定者リストを元に、簡単に出欠（実績）を記録できるようにする。
設計のヒント: MonthlyPlannerPageで作成したロジックを応用し、「今日」の利用予定者をリストアップする機能が基礎となります。
6. 補足・関連資料
ソースコード管理: Gitリポジトリ [リポジトリのURLを記載]
デザイン: Figma [デザインカンプのURLを記載]
主要技術スタック: React, TypeScript, MUI, Firebase (Firestore)
引き継ぎ書：追記】フェーズ3『利用者CRM基盤の強化』におけるアーキテクチャ改善と進捗
はじめに
MonthlyPlannerPage.jsx（月次計画サマリー）の実装過程において、当初の想定を大幅に超えるアーキテクチャ上の課題が顕在化した。しかし、あなたの的確な設計思想と指示に基づき、これらの課題を抜本的に解決。結果として、今後の機能拡張を加速させる、極めて堅牢で保守性の高いアプリケーション基盤を確立することに成功した。
以下に、今回達成した内容と、そこから得られた教訓を詳述する。
1. 新規実装した機能
1-1. 「支援作業ダッシュボード」(SupportWorkPage.jsx) の構築
あなたの設計思想に基づき、関連性の高い業務機能をグルーピングするための「ミニダッシュボード」を新設した。
目的: 職員が「支援作業」という一つの業務カテゴリから、関連する全ての機能（全利用者一覧、月次計画、日次出欠記録など）へ直感的にアクセスできるようにする。
デザイン: 単なるリンク集ではなく、各機能に関連する重要な指標（総利用者数、今月の総コマ数など）をリアルタイムで表示するウィジェット形式を採用。「一目で状況がわかる」という、真のダッシュボードとしての価値を提供する。
効果: 将来、「支援記録」などの新機能が増えても、このダッシュボードに追加していくだけで済むため、左メニューの肥大化を防ぎ、アプリケーションの拡張性を飛躍的に向上させた。
2. 達成したアーキテクチャ改善と、そこから得られた教訓
今回のプロセスは、単なる機能実装に留まらず、プロジェクト全体の「作り方」そのものを見直す貴重な機会となった。
2-1. ルーティング構造の確立（トップレベルroutesパターン）
課題（Before）: ルーティング定義が各機能フォルダ（features）内に分散しており、アプリケーションの全体像を把握しにくい構造だった。また、機能追加のたびにApp.jsxを編集する必要があり、将来的な肥大化とメンテナンス性の低下が懸念された。
解決策（After）: あなたの**「本体を壊さず追加パーツを作る」**という思想に基づき、アーキテクチャを刷新。全てのルート定義をsrc/routesという一つのフォルダ（＝背骨）に集約し、App.jsxはそれを呼び出すだけのシンプルな形にした。
教訓: この「トップレベルroutesパターン」こそが、モノレポ構造を持つ本アプリの最適解である。これにより、今後の機能追加はsrc/routesフォルダへの追記だけで完結し、将来にわたって禍根を残すことなく、安全かつ迅速な開発が可能となった。
2-2. UIコンポーネントの責務分離と「適材適所」の徹底
課題（Before）: MUIの既存コンポーネント<DateCalendar>の仕様に固執し、CSSで無理やり見た目を改造しようとした結果、レイアウトの崩壊、表示のズレ、月ごとの再描画バグなど、多数の問題を引き起こした。
解決策（After）: あなたの**「使えないものは使えないと認識する」という的確な判断に基づき、<DateCalendar>を完全に破棄**。代わりにdate-fnsで常に6行7列の崩れないデータ構造を自前で生成し、それをCSS Gridを用いて描画するカスタムコンポーネントをゼロから構築した。
教訓: **「テーブルでかっちり組む」**というあなたの設計思想の通り、UIは常にその目的に合った最もシンプルな技術（適材適所）で構築するべきである。複雑なライブラリの挙動に振り回されるのではなく、データの構造を正しく定義すれば、UIは自ずと堅牢になることを学んだ。
3. 今後の展望と次のアクション
盤石のアーキテクチャが完成した今、ついに日次出欠記録の実装に着手する。
次の実装: DailyCheckinPage.jsx の本格的な構築。
現状:
「支援作業ダッシュボード」に、このページへの入り口は既に用意されている。
ルーティング設定も完了済み。
MonthlyPlannerPageで確立した、Firestoreから予定を取得するロジックを応用できる。
タスク:
「今日」の利用予定者リストを表示するUIを構築する。
職員が「出席」「欠席」などを記録し、attendanceRecordsコレクションに保存するロキジックを実装する。
この土台があれば、もはや迷うことはない。最速で、最高品質の機能を実装する。
【引き継ぎ書 Ver.3.0】Office Suite - CRM基盤刷新とUX改善報告
プロジェクト: Office Suite / Client Management System
作成日: 2025年11月21日
更新内容: ステータス定義の標準化、ロスト分析機能の強化、全利用者一覧のUX改善、データ整合性の修正
1. 実施した改修の概要 (Executive Summary)
本フェーズでは、システム運用における「データの正確性」と「可視化」を最優先課題とし、CRM機能の基盤刷新を行いました。
具体的には、バラバラだったステータス定義を統一し、**「誰が、どの段階で、なぜ利用終了したか」**を正確に追跡・分析できる仕組みを構築しました。また、これに伴う既存データの不整合を解消する移行ツールを実装・実行しました。
2. 【最重要】データモデルと定義の標準化
これまでハードコードされていたステータス文字列（lead-new等）を廃止し、システム全体で統一された定数管理へ移行しました。
2-1. ステータス定義の刷新 (src/constants/clientStatus.js)
全ステータスID、日本語ラベル、表示色（カラーコード）を一元管理する構造に変更しました。
旧ID (Legacy)	新ID (Current)	日本語ラベル	備考
lead-new	inquiry	新規問合せ	
lead-consulting	interview	相談・見学	
lead-trial	trial	体験利用	
contract-prep	pre_contract	契約準備中	
follow_up	follow-up-m1	定着支援 1ヶ月目	※旧データも自動移行対応済
closed-lost	closed	利用終了	※理由は lostAtPhase で管理
2-2. 終了理由 (Lost Analysis) の精密化
これまでは全て「Closed（利用終了）」として一括りにされていましたが、「どのフェーズで離脱したか (lostAtPhase)」 を記録するロジックを実装しました。
これにより、「見学ロスト」「体験ロスト」といった詳細な分析が可能になりました。
3. 実装機能の詳細解説
3-1. カンバンボードのロジック改修 (ClientKanbanPage.jsx)
矢印ナビゲーションの復旧: ステータスID変更により消失していた「←（戻る）」「→（進む）」ボタンを、新定義に基づいて再実装しました。
ロスト処理の強化: 「×」ボタンで削除する際、現在のフェーズ（inquiry 等）を lostAtPhase としてDBに記録するよう改修しました。
3-2. ロストカウンターの実装 (LostCounter.jsx)
正確な集計: status: closed のデータの中から、lostAtPhase を参照して「見学で落ちた人数」「体験で落ちた人数」を個別にカウントアップするロジックを実装しました。
デザイン修正: 汎用的な白背景ではなく、システム全体のテーマに合わせた「ダーク背景＋シアン色枠線」のサイバーパンク風デザインを適用しました。
3-3. 全利用者一覧のUX大幅改善 (AllClientsListPage.jsx)
ステータスのカラーコード化: 文字列だけでなく、ステータスごとに定義された色（Cyan, Blue, Violet, Pink等）でチップを表示し、視認性を向上させました。
詳細な終了理由の表示: 「利用終了」という単一表示をやめ、「問合せロスト」「見学ロスト」といった具体的な離脱フェーズを表示。さらに**「理由・詳細」カラム**を追加し、備考欄の内容を一目で確認可能にしました。
フィルタリング強化: 「見学ロストのみ」などの細かい絞り込み検索機能を追加しました。
ヘッダーデザイン: ダークモードに最適化した黒背景・白文字ヘッダーに変更しました。
4. データ移行とメンテナンス (Data Migration)
新システムへの移行に伴い、過去データの整合性を保つための管理者用ツールを作成・実行しました。
4-1. ステータス移行ツール (AdminCleanupPage.jsx)
機能: 旧ID（lead-new, follow_up 等）を持つドキュメントを検索し、新ID（inquiry, follow-up-m1 等）へ一括変換するバッチ処理を実装しました。
実施結果: 全データの変換作業は完了済みです。定着支援データが表示されない問題も、このツールによる正規化で解消しました。
セキュリティ対策: 本番環境（src/App.jsx）では、誤操作防止のため /cleanup ルートをコメントアウト（封印）済みです。
5. 今後の課題とネクストアクション (Next Steps)
CRM基盤が盤石になったことで、以下の機能拡張へスムーズに移行できます。
日次出欠記録 (DailyCheckinPage) の実装:
CRMの利用者が確定したため、次は「本日の利用者」をリストアップし、出欠を記録する画面の構築に着手します。
CSV出力機能の実装:
一覧画面にある「ダウンロードボタン」は現在プレースホルダーです。実務で使えるCSVエクスポート機能を実装します。
請求データ連携:
正確になったステータスと利用実績データを元に、請求計算ロジックを組み込みます。
👨‍💻 開発担当者より (Developer Notes)
コンソール警告について: MUI v5への移行に伴う <Grid> 関連の警告は可能な限り解消しましたが、一部ビルド依存のものが残る可能性があります。動作には影響ありません。
デプロイ状況: 2025/11/21 時点の最新コードは Firebase Hosting (manecto.web.app) にデプロイ済みであり、データ移行も完了しています。
コード管理: ステータス関連の変更を行う際は、必ず src/constants/clientStatus.js を参照し、ハードコードを避ける設計を徹底してください。
以上